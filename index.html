<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Kanban Temps R√©el</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #f3f4f6;
      font-family: system-ui, sans-serif;
      color: #111827;
    }

    header {
      background: #111827;
      color: white;
      padding: 1rem 2rem;
      display: flex; justify-content: space-between; align-items: center;
    }

    .board {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      padding: 1rem;
    }

    .column {
      background: #e5e7eb;
      padding: 0.75rem;
      border-radius: 0.75rem;
      min-width: 280px;
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
    }

    .column-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: .5rem;
    }

    .column-title { font-weight: 600; cursor: pointer; }
    .column-title:hover { opacity: .7; }

    .column-actions button {
      background: transparent; border: none; cursor: pointer;
      font-size: 1rem; opacity: .6;
    }
    .column-actions button:hover { opacity: 1; }

    .subcategory {
      background: #d1d5db;
      padding: .4rem;
      border-radius: .5rem;
      margin-bottom: .5rem;
    }

    .subcategory--none {
      background: #cbd5e1;
    }

    .subcategory-title { font-size: .85rem; cursor: pointer; }
    .subcategory-title:hover { opacity: .7; }

    .subcategory-body {
      min-height: 20px;
      border-radius: .4rem;
      padding: .2rem;
    }

    .subcategory-body--hover {
      outline: 2px dashed #444;
      background: #e5e7eb;
    }

    .card {
      background: white;
      padding: .5rem;
      margin-bottom: .4rem;
      border-radius: .6rem;
      cursor: grab;
      box-shadow: 0 1px 2px rgba(0,0,0,.15);
    }

    .card:active {
      transform: scale(1.02);
      box-shadow: 0 4px 10px rgba(0,0,0,.15);
      cursor: grabbing;
    }

    .top-bar {
      display: flex; flex-wrap: wrap;
      gap: .75rem;
      padding: 1rem;
    }

    .form-inline {
      background: #e5e7eb; padding: .5rem .8rem;
      border-radius: 999px;
      display: flex; gap: .4rem; align-items: center;
    }

    input, select {
      padding: .3rem .5rem; border: none; border-radius: 999px;
      background: white;
    }

    .btn {
      padding: .35rem .8rem;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: white;
      cursor: pointer;
    }
  </style>
</head>

<body>
<header>
  <h1>Kanban Temps R√©el</h1>
  <div id="statusText">Connect√©</div>
</header>

<div class="top-bar">

  <!-- Formulaire t√¢che -->
  <form id="addTaskForm" class="form-inline">
    <input type="text" id="taskTitle" placeholder="Titre" required />
    <input type="text" id="taskDesc" placeholder="Description" />
    <select id="taskColumn"></select>
    <select id="taskSubcategory"></select>
    <button class="btn">+ Carte</button>
  </form>

  <!-- Formulaire colonne -->
  <form id="addColumnForm" class="form-inline">
    <input type="text" id="columnName" placeholder="Nouvelle cat√©gorie" required />
    <button class="btn">+ Cat√©gorie</button>
  </form>

</div>

<section id="board" class="board"></section>

<footer style="text-align:center; padding:1rem; color:#777">
  H√©berg√© sur GitHub Pages
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBsHFp5MfmldTvcDkatE4P9gXNRZ1Ivk0o",
  authDomain: "ems-dispatch-d1cd2.firebaseapp.com",
  projectId: "ems-dispatch-d1cd2",
  storageBucket: "ems-dispatch-d1cd2.firebasestorage.app",
  messagingSenderId: "529717769926",
  appId: "1:529717769926:web:6cf7c152a0ca5fbccac9c7",
  measurementId: "G-TZZFDBHVM2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* === VARIABLES === */
let columns = [];
let subcategories = [];
let tasks = [];
let hasInit = false;

const board = document.getElementById("board");
const taskColSel = document.getElementById("taskColumn");
const taskSubSel = document.getElementById("taskSubcategory");
const taskForm = document.getElementById("addTaskForm");
const colForm = document.getElementById("addColumnForm");

/* === UTILS === */
function formatDate(t){
  if(!t) return "";
  const d=t.toDate();
  return d.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});
}

function updateSelectors(){
  taskColSel.innerHTML="";
  columns.forEach(c=>{
    const o=document.createElement("option");
    o.value=c.id; o.textContent=c.name;
    taskColSel.appendChild(o);
  });

  updateSubSelector();
}

function updateSubSelector(){
  taskSubSel.innerHTML="";
  const none=document.createElement("option");
  none.value=""; none.textContent="Sans sous-cat√©gorie";
  taskSubSel.appendChild(none);

  const colId=taskColSel.value;
  subcategories
    .filter(s=>s.columnId===colId)
    .sort((a,b)=>(a.order||0)-(b.order||0))
    .forEach(s=>{
      const o=document.createElement("option");
      o.value=s.id; o.textContent=s.name;
      taskSubSel.appendChild(o);
    });
}

taskColSel.addEventListener("change",updateSubSelector);

/* === CR√âATION CARTE === */
function createCard(id,data,label){
  const c=document.createElement("div");
  c.className="card"; c.draggable=true; c.dataset.id=id;

  c.innerHTML=`
    <div class="card-title">${data.title}</div>
    ${data.description ? `<div class="card-desc">${data.description}</div>` : ""}
    <div class="card-meta">
      <span class="tag">${label}</span>
      <span>${formatDate(data.createdAt)}</span>
    </div>
  `;

  c.addEventListener("dragstart",e=>{
    e.dataTransfer.setData("text/plain",id);
  });

  c.addEventListener("dblclick",async()=>{
    if(confirm("Supprimer cette carte ?")){
      await db.collection("tasks").doc(id).delete();
    }
  });

  return c;
}

/* === RENDU DU KANBAN === */
function renderBoard(){
  board.innerHTML="";

  columns.forEach(col=>{
    const colBox=document.createElement("div");
    colBox.className="column";

    /* HEADER */
    const head=document.createElement("div");
    head.className="column-header";

    const title=document.createElement("span");
    title.className="column-title";
    title.textContent=col.name;

    title.addEventListener("dblclick",()=>{
      const n=prompt("Renommer :",col.name);
      if(n) db.collection("columns").doc(col.id).update({name:n});
    });

    const actions=document.createElement("div");
    actions.className="column-actions";

    const addSub=document.createElement("button");
    addSub.textContent="+";
    addSub.title="Ajouter une sous-cat√©gorie";
    addSub.onclick=async()=>{
      const n=prompt("Nom sous-cat√©gorie :");
      if(!n) return;
      const order=subcategories.filter(s=>s.columnId===col.id).length;
      await db.collection("subcategories").add({
        columnId:col.id,name:n,order,
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });
    };

    const del=document.createElement("button");
    del.textContent="üóë";
    del.onclick=()=>{
      if(confirm("Supprimer la cat√©gorie ?")){
        deleteColumn(col.id);
      }
    };

    actions.append(addSub,del);
    head.append(title,actions);
    colBox.appendChild(head);

    /* BODY */
    const body=document.createElement("div");
    body.className="column-body";

    const tasksInCol=tasks.filter(t=>t.columnId===col.id);

    /* --- Sans sous-cat√©gorie (TOUJOURS pr√©sent) --- */
    const noSubBox=document.createElement("div");
    noSubBox.className="subcategory subcategory--none";

    noSubBox.innerHTML=`<div class="subcategory-header">
      <span class="subcategory-title">Sans sous-cat√©gorie</span>
      <span class="subcategory-count">${tasksInCol.filter(t=>!t.subcategoryId).length}</span>
    </div>`;

    const noSubBody=document.createElement("div");
    noSubBody.className="subcategory-body";
    noSubBody.dataset.columnId=col.id;
    noSubBody.dataset.subId="";

    noSubBody.addEventListener("dragover",e=>{
      e.preventDefault(); noSubBody.classList.add("subcategory-body--hover");
    });
    noSubBody.addEventListener("dragleave",()=>noSubBody.classList.remove("subcategory-body--hover"));
    noSubBody.addEventListener("drop",async e=>{
      e.preventDefault(); noSubBody.classList.remove("subcategory-body--hover");
      const id=e.dataTransfer.getData("text/plain");
      await db.collection("tasks").doc(id).update({
        columnId:col.id, subcategoryId:null
      });
    });

    tasksInCol.filter(t=>!t.subcategoryId).forEach(t=>{
      noSubBody.appendChild(createCard(t.id,t,col.name));
    });

    noSubBox.appendChild(noSubBody);
    body.appendChild(noSubBox);

    /* --- SOUS-CAT√âGORIES --- */
    subcategories
      .filter(s=>s.columnId===col.id)
      .sort((a,b)=>(a.order||0)-(b.order||0))
      .forEach(sub=>{
        const subBox=document.createElement("div");
        subBox.className="subcategory";

        const sh=document.createElement("div");
        sh.className="subcategory-header";

        const st=document.createElement("span");
        st.className="subcategory-title";
        st.textContent=sub.name;

        st.addEventListener("dblclick",()=>{
          const n=prompt("Renommer :",sub.name);
          if(n) db.collection("subcategories").doc(sub.id).update({name:n});
        });

        const sc=document.createElement("span");
        sc.className="subcategory-count";
        sc.textContent=tasksInCol.filter(t=>t.subcategoryId===sub.id).length;

        const delS=document.createElement("button");
        delS.textContent="üóë";
        delS.onclick=()=>deleteSub(sub.id);

        sh.append(st,sc,delS);

        const sb=document.createElement("div");
        sb.className="subcategory-body";
        sb.dataset.columnId=col.id;
        sb.dataset.subId=sub.id;

        sb.addEventListener("dragover",e=>{
          e.preventDefault(); sb.classList.add("subcategory-body--hover");
        });
        sb.addEventListener("dragleave",()=>sb.classList.remove("subcategory-body--hover"));
        sb.addEventListener("drop",async e=>{
          e.preventDefault(); sb.classList.remove("subcategory-body--hover");
          const id=e.dataTransfer.getData("text/plain");
          await db.collection("tasks").doc(id).update({
            columnId:col.id, subcategoryId:sub.id
          });
        });

        tasksInCol.filter(t=>t.subcategoryId===sub.id).forEach(t=>{
          sb.appendChild(createCard(t.id,t,sub.name));
        });

        subBox.append(sh,sb);
        body.appendChild(subBox);
      });

    colBox.appendChild(body);
    board.appendChild(colBox);
  });

  updateSelectors();
}

/* === SUPPRESSION COLONNE === */
async function deleteColumn(id){
  const ts=await db.collection("tasks").where("columnId","==",id).get();
  const subs=await db.collection("subcategories").where("columnId","==",id).get();
  const b=db.batch();
  ts.forEach(d=>b.delete(d.ref));
  subs.forEach(d=>b.delete(d.ref));
  b.delete(db.collection("columns").doc(id));
  await b.commit();
}

/* === SUPPRESSION SOUS-CAT√âGORIE === */
async function deleteSub(id){
  if(!confirm("Supprimer la sous-cat√©gorie ?")) return;
  const ts=await db.collection("tasks").where("subcategoryId","==",id).get();
  const b=db.batch();
  ts.forEach(d=>b.update(d.ref,{subcategoryId:null}));
  b.delete(db.collection("subcategories").doc(id));
  await b.commit();
}

/* === FIRESTORE LISTENERS === */
db.collection("columns").orderBy("order").onSnapshot(s=>{
  if(!hasInit && s.empty){
    hasInit=true;
    ["√Ä faire","En cours","Termin√©"].forEach((n,i)=>{
      db.collection("columns").add({
        name:n, order:i, createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    return;
  }
  columns=s.docs.map(d=>({id:d.id,...d.data()}));
  renderBoard();
});

db.collection("subcategories").orderBy("order").onSnapshot(s=>{
  subcategories=s.docs.map(d=>({id:d.id,...d.data()}));
  renderBoard();
});

db.collection("tasks").orderBy("createdAt").onSnapshot(s=>{
  tasks=s.docs.map(d=>({id:d.id,...d.data()}));
  renderBoard();
});

/* === FORM ADD TASK === */
taskForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const title=document.getElementById("taskTitle").value.trim();
  const desc=document.getElementById("taskDesc").value.trim();
  const col=taskColSel.value;
  const sub=taskSubSel.value || null;

  if(!title) return;

  await db.collection("tasks").add({
    title, description:desc, columnId:col,
    subcategoryId:sub,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  taskForm.reset();
});

/* === FORM ADD COLUMN === */
colForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const name=document.getElementById("columnName").value.trim();
  if(!name) return;
  const order=columns.length;
  await db.collection("columns").add({
    name, order,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  colForm.reset();
});
</script>

</body>
</html>
