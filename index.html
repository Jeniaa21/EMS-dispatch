<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Kanban Temps R√©el</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    header {
      padding: 1rem 2rem;
      background: #111827;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }

    main {
      padding: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Board dynamique avec scroll horizontal si beaucoup de colonnes */
    .board {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }

    .column {
      background: #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 180px);
      min-width: 260px;
      flex: 0 0 auto;
    }

    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.35rem;
    }

    .column-title {
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      padding: 0.1rem 0.3rem;
      border-radius: 0.5rem;
    }

    .column-title:hover {
      background: rgba(0,0,0,0.05);
    }

    .column-count {
      background: #111827;
      color: white;
      border-radius: 999px;
      padding: 0 0.5rem;
      font-size: 0.75rem;
    }

    .column-actions {
      display: flex;
      gap: 0.15rem;
      align-items: center;
    }

    .icon-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.9rem;
      line-height: 1;
      opacity: 0.6;
      padding: 0.1rem;
    }

    .icon-btn:hover {
      opacity: 1;
    }

    .column-body {
      flex: 1;
      overflow-y: auto;
      padding: 0.25rem;
      border-radius: 0.5rem;
      transition: background 0.15s ease, outline 0.15s ease;
    }

    .column-body--hover {
      background: #d1d5db;
      outline: 2px dashed #374151;
      outline-offset: -2px;
    }

    .card {
      background: white;
      border-radius: 0.75rem;
      padding: 0.5rem 0.6rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      cursor: grab;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .card:active {
      cursor: grabbing;
      transform: scale(1.02);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }

    .card-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
    }

    .card-desc {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 0.25rem;
    }

    .card-meta {
      font-size: 0.7rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tag {
      font-size: 0.7rem;
      background: #eef2ff;
      color: #3730a3;
      border-radius: 999px;
      padding: 0.05rem 0.4rem;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .form-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      background: #e5e7eb;
      padding: 0.4rem 0.6rem;
      border-radius: 999px;
    }

    .form-inline input,
    .form-inline select {
      border: none;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      outline: none;
      background: white;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 0.35rem 0.8rem;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      background: #111827;
      color: white;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.05s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 rgba(0,0,0,0.2);
    }

    .badge-live {
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.1);
      color: #a7f3d0;
    }

    .badge-live-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #34d399;
      box-shadow: 0 0 0 4px rgba(52, 211, 153, 0.35);
    }

    .status {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .status.ok {
      color: #10b981;
    }

    .status.err {
      color: #ef4444;
    }

    footer {
      font-size: 0.7rem;
      text-align: center;
      padding: 0.5rem;
      color: #6b7280;
    }

    @media (max-width: 768px) {
      .board {
        flex-direction: row;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>Kanban Temps R√©el</h1>
  <div>
    <div class="badge-live">
      <span class="badge-live-dot"></span>
      Synchro temps r√©el
    </div>
    <div id="statusText" class="status ok">Connect√©</div>
  </div>
</header>

<main>
  <div class="top-bar">
    <!-- Formulaire ajout de t√¢che -->
    <form id="addTaskForm" class="form-inline">
      <input type="text" id="taskTitle" placeholder="Titre" required />
      <input type="text" id="taskDesc" placeholder="Description (optionnel)" />
      <select id="taskColumn"></select>
      <button type="submit" class="btn">+ Ajouter une carte</button>
    </form>

    <!-- Formulaire ajout de cat√©gorie -->
    <form id="addColumnForm" class="form-inline">
      <input type="text" id="columnName" placeholder="Nouvelle cat√©gorie" required />
      <button type="submit" class="btn">+ Ajouter une cat√©gorie</button>
    </form>
  </div>

  <!-- Colonnes g√©n√©r√©es dynamiquement -->
  <section id="board" class="board"></section>
</main>

<footer>
  H√©berge ce fichier sur GitHub Pages pour partager ton Kanban avec tout le monde.
</footer>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  // üîß CONFIG FIREBASE (tu as d√©j√† ces valeurs)
  const firebaseConfig = {
    apiKey: "AIzaSyBsHFp5MfmldTvcDkatE4P9gXNRZ1Ivk0o",
    authDomain: "ems-dispatch-d1cd2.firebaseapp.com",
    projectId: "ems-dispatch-d1cd2",
    storageBucket: "ems-dispatch-d1cd2.firebasestorage.app",
    messagingSenderId: "529717769926",
    appId: "1:529717769926:web:6cf7c152a0ca5fbccac9c7",
    measurementId: "G-TZZFDBHVM2"
  };

  // Initialisation Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const statusText = document.getElementById("statusText");
  const addTaskForm = document.getElementById("addTaskForm");
  const addColumnForm = document.getElementById("addColumnForm");
  const taskTitleInput = document.getElementById("taskTitle");
  const taskDescInput = document.getElementById("taskDesc");
  const taskColumnSelect = document.getElementById("taskColumn");
  const columnNameInput = document.getElementById("columnName");
  const board = document.getElementById("board");

  let columns = [];  // {id, name, order, createdAt}
  let tasks = [];    // {id, title, description, columnId, createdAt}
  let hasInitializedColumns = false;

  function setStatus(msg, ok = true) {
    statusText.textContent = msg;
    statusText.classList.toggle("ok", ok);
    statusText.classList.toggle("err", !ok);
  }

  function formatDate(timestamp) {
    if (!timestamp) return "";
    const date = timestamp.toDate();
    return date.toLocaleString("fr-FR", {
      day: "2-digit",
      month: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function updateTaskColumnSelect() {
    taskColumnSelect.innerHTML = "";
    columns.forEach(col => {
      const opt = document.createElement("option");
      opt.value = col.id;
      opt.textContent = col.name;
      taskColumnSelect.appendChild(opt);
    });
  }

  function createCard(id, data, columnName) {
    const card = document.createElement("div");
    card.className = "card";
    card.draggable = true;
    card.dataset.id = id;

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = data.title || "(Sans titre)";

    const desc = document.createElement("div");
    desc.className = "card-desc";
    desc.textContent = data.description || "";

    const meta = document.createElement("div");
    meta.className = "card-meta";

    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = columnName || "Sans cat√©gorie";

    const date = document.createElement("span");
    date.textContent = formatDate(data.createdAt);

    meta.appendChild(tag);
    meta.appendChild(date);

    card.appendChild(title);
    if (data.description) card.appendChild(desc);
    card.appendChild(meta);

    // Drag & drop
    card.addEventListener("dragstart", (e) => {
      e.dataTransfer.setData("text/plain", id);
    });

    // Double-clic : suppression de la carte
    card.addEventListener("dblclick", async () => {
      if (confirm("Supprimer cette carte ?")) {
        try {
          await db.collection("tasks").doc(id).delete();
        } catch (err) {
          console.error(err);
          alert("Erreur lors de la suppression.");
        }
      }
    });

    return card;
  }

  async function deleteColumnAndTasks(columnId, columnName) {
    const ok = confirm(`Supprimer la cat√©gorie "${columnName}" et toutes ses cartes ?`);
    if (!ok) return;

    try {
      setStatus("Suppression de la cat√©gorie...", true);
      const snap = await db.collection("tasks").where("columnId", "==", columnId).get();
      const batch = db.batch();
      snap.forEach(doc => batch.delete(doc.ref));
      const colRef = db.collection("columns").doc(columnId);
      batch.delete(colRef);
      await batch.commit();
      setStatus("Connect√©", true);
    } catch (err) {
      console.error(err);
      setStatus("Erreur lors de la suppression de la cat√©gorie", false);
      alert("Erreur lors de la suppression de la cat√©gorie.");
    }
  }

  function renderBoard() {
    board.innerHTML = "";

    columns.forEach(column => {
      const colArticle = document.createElement("article");
      colArticle.className = "column";

      // HEADER
      const header = document.createElement("div");
      header.className = "column-header";

      const headerLeft = document.createElement("div");
      headerLeft.style.display = "flex";
      headerLeft.style.alignItems = "center";
      headerLeft.style.gap = "0.35rem";

      const titleSpan = document.createElement("span");
      titleSpan.className = "column-title";
      titleSpan.textContent = column.name;

      // Renommage sur double-clic
      titleSpan.addEventListener("dblclick", () => {
        const input = document.createElement("input");
        input.type = "text";
        input.value = column.name;
        input.style.fontSize = "0.9rem";
        input.style.padding = "0.1rem 0.3rem";
        input.style.borderRadius = "0.5rem";
        input.style.border = "1px solid #9ca3af";
        input.style.outline = "none";
        headerLeft.replaceChild(input, titleSpan);
        input.focus();
        input.select();

        const finish = async (save) => {
          const newName = input.value.trim();
          headerLeft.replaceChild(titleSpan, input);
          if (save && newName && newName !== column.name) {
            try {
              await db.collection("columns").doc(column.id).update({ name: newName });
            } catch (err) {
              console.error(err);
              alert("Erreur lors du renommage de la cat√©gorie.");
            }
          }
        };

        input.addEventListener("blur", () => finish(true));
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") finish(true);
          if (e.key === "Escape") finish(false);
        });
      });

      const countSpan = document.createElement("span");
      countSpan.className = "column-count";

      headerLeft.appendChild(titleSpan);
      headerLeft.appendChild(countSpan);

      const headerActions = document.createElement("div");
      headerActions.className = "column-actions";

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "icon-btn";
      deleteBtn.title = "Supprimer la cat√©gorie";
      deleteBtn.textContent = "üóë";
      deleteBtn.addEventListener("click", () => {
        deleteColumnAndTasks(column.id, column.name);
      });

      headerActions.appendChild(deleteBtn);

      header.appendChild(headerLeft);
      header.appendChild(headerActions);

      // BODY
      const body = document.createElement("div");
      body.className = "column-body";
      body.dataset.columnId = column.id;

      // T√¢ches de cette colonne
      const tasksForColumn = tasks.filter(t => t.columnId === column.id);
      countSpan.textContent = tasksForColumn.length;

      tasksForColumn.forEach(item => {
        const card = createCard(item.id, item, column.name);
        body.appendChild(card);
      });

      // Drag & drop sur la colonne
      body.addEventListener("dragover", (e) => {
        e.preventDefault();
        body.classList.add("column-body--hover");
      });

      body.addEventListener("dragleave", () => {
        body.classList.remove("column-body--hover");
      });

      body.addEventListener("drop", async (e) => {
        e.preventDefault();
        body.classList.remove("column-body--hover");
        const id = e.dataTransfer.getData("text/plain");
        if (!id) return;

        try {
          await db.collection("tasks").doc(id).update({ columnId: column.id });
        } catch (err) {
          console.error(err);
          alert("Erreur lors du d√©placement de la carte.");
        }
      });

      colArticle.appendChild(header);
      colArticle.appendChild(body);
      board.appendChild(colArticle);
    });

    // Met √† jour la liste d√©roulante des cat√©gories pour les cartes
    updateTaskColumnSelect();
  }

  async function createDefaultColumns() {
    const names = ["√Ä faire", "En cours", "Termin√©"];
    const batch = db.batch();
    const colsRef = db.collection("columns");
    names.forEach((name, index) => {
      const ref = colsRef.doc();
      batch.set(ref, {
        name,
        order: index,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await batch.commit();
  }

  // üîÑ √âcoute temps r√©el des colonnes
  db.collection("columns")
    .orderBy("order", "asc")
    .onSnapshot(async (snapshot) => {
      setStatus("Connect√©");
      if (!hasInitializedColumns && snapshot.empty) {
        hasInitializedColumns = true;
        // cr√©e 3 colonnes par d√©faut si la collection est vide
        await createDefaultColumns();
        return;
      }
      hasInitializedColumns = true;
      columns = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      renderBoard();
    }, (error) => {
      console.error(error);
      setStatus("Erreur de connexion aux cat√©gories", false);
    });

  // üîÑ √âcoute temps r√©el des t√¢ches
  db.collection("tasks")
    .orderBy("createdAt", "asc")
    .onSnapshot((snapshot) => {
      setStatus("Connect√©");
      tasks = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      renderBoard();
    }, (error) => {
      console.error(error);
      setStatus("Erreur de connexion aux t√¢ches", false);
    });

  // ‚ûï Ajout de carte
  addTaskForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const title = taskTitleInput.value.trim();
    const description = taskDescInput.value.trim();
    const columnId = taskColumnSelect.value;

    if (!title || !columnId) return;

    try {
      await db.collection("tasks").add({
        title,
        description,
        columnId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      taskTitleInput.value = "";
      taskDescInput.value = "";
    } catch (err) {
      console.error(err);
      alert("Erreur lors de l'ajout de la t√¢che.");
    }
  });

  // ‚ûï Ajout de cat√©gorie
  addColumnForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = columnNameInput.value.trim();
    if (!name) return;

    try {
      const order = columns.length ? Math.max(...columns.map(c => c.order || 0)) + 1 : 0;
      await db.collection("columns").add({
        name,
        order,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      columnNameInput.value = "";
    } catch (err) {
      console.error(err);
      alert("Erreur lors de l'ajout de la cat√©gorie.");
    }
  });
</script>
</body>
</html>
