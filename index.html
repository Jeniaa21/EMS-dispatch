<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Kanban Temps R√©el</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    header {
      padding: 1rem 2rem;
      background: #111827;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }

    main {
      padding: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Board horizontal */
    .board {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }

    .column {
      background: #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 180px);
      min-width: 260px;
      flex: 0 0 auto;
    }

    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.35rem;
    }

    .column-title {
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      padding: 0.1rem 0.3rem;
      border-radius: 0.5rem;
    }

    .column-title:hover {
      background: rgba(0,0,0,0.05);
    }

    .column-count {
      background: #111827;
      color: white;
      border-radius: 999px;
      padding: 0 0.5rem;
      font-size: 0.75rem;
    }

    .column-actions {
      display: flex;
      gap: 0.15rem;
      align-items: center;
    }

    .icon-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.9rem;
      line-height: 1;
      opacity: 0.6;
      padding: 0.1rem;
    }

    .icon-btn:hover {
      opacity: 1;
    }

    .column-body {
      flex: 1;
      overflow-y: auto;
      padding: 0.25rem;
      border-radius: 0.5rem;
    }

    /* bloc sous-cat√©gorie */
    .subcategory {
      background: #d1d5db;
      border-radius: 0.6rem;
      padding: 0.3rem;
      margin-bottom: 0.4rem;
    }

    .subcategory--none {
      background: transparent;
      padding-top: 0;
    }

    .subcategory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.2rem;
      gap: 0.25rem;
    }

    .subcategory-title {
      font-weight: 500;
      font-size: 0.8rem;
      cursor: pointer;
      padding: 0.05rem 0.3rem;
      border-radius: 0.4rem;
    }

    .subcategory-title:hover {
      background: rgba(0,0,0,0.06);
    }

    .subcategory-count {
      font-size: 0.7rem;
      background: #4b5563;
      color: white;
      border-radius: 999px;
      padding: 0 0.45rem;
    }

    .subcategory-body {
      border-radius: 0.4rem;
      padding: 0.15rem;
      min-height: 24px;
      transition: background 0.15s ease, outline 0.15s ease;
    }

    .subcategory-body--hover {
      background: #e5e7eb;
      outline: 2px dashed #374151;
      outline-offset: -2px;
    }

    .card {
      background: white;
      border-radius: 0.75rem;
      padding: 0.5rem 0.6rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      cursor: grab;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .card:active {
      cursor: grabbing;
      transform: scale(1.02);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }

    .card-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
    }

    .card-desc {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 0.25rem;
    }

    .card-meta {
      font-size: 0.7rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tag {
      font-size: 0.7rem;
      background: #eef2ff;
      color: #3730a3;
      border-radius: 999px;
      padding: 0.05rem 0.4rem;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .form-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      background: #e5e7eb;
      padding: 0.4rem 0.6rem;
      border-radius: 999px;
    }

    .form-inline input,
    .form-inline select {
      border: none;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      outline: none;
      background: white;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 0.35rem 0.8rem;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      background: #111827;
      color: white;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.05s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 rgba(0,0,0,0.2);
    }

    .badge-live {
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.1);
      color: #a7f3d0;
    }

    .badge-live-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #34d399;
      box-shadow: 0 0 0 4px rgba(52, 211, 153, 0.35);
    }

    .status {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .status.ok {
      color: #10b981;
    }

    .status.err {
      color: #ef4444;
    }

    footer {
      font-size: 0.7rem;
      text-align: center;
      padding: 0.5rem;
      color: #6b7280;
    }

    @media (max-width: 768px) {
      .board {
        flex-direction: row;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>Kanban Temps R√©el</h1>
  <div>
    <div class="badge-live">
      <span class="badge-live-dot"></span>
      Synchro temps r√©el
    </div>
    <div id="statusText" class="status ok">Connect√©</div>
  </div>
</header>

<main>
  <div class="top-bar">
    <!-- Formulaire ajout de t√¢che -->
    <form id="addTaskForm" class="form-inline">
      <input type="text" id="taskTitle" placeholder="Titre" required />
      <input type="text" id="taskDesc" placeholder="Description (optionnel)" />
      <select id="taskColumn"></select>
      <select id="taskSubcategory"></select>
      <button type="submit" class="btn">+ Ajouter une carte</button>
    </form>

    <!-- Formulaire ajout de cat√©gorie -->
    <form id="addColumnForm" class="form-inline">
      <input type="text" id="columnName" placeholder="Nouvelle cat√©gorie" required />
      <button type="submit" class="btn">+ Ajouter une cat√©gorie</button>
    </form>
  </div>

  <!-- Colonnes g√©n√©r√©es dynamiquement -->
  <section id="board" class="board"></section>
</main>

<footer>
  H√©berge ce fichier sur GitHub Pages pour partager ton Kanban avec tout le monde.
</footer>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  // üîß CONFIG FIREBASE (tes valeurs)
  const firebaseConfig = {
    apiKey: "AIzaSyBsHFp5MfmldTvcDkatE4P9gXNRZ1Ivk0o",
    authDomain: "ems-dispatch-d1cd2.firebaseapp.com",
    projectId: "ems-dispatch-d1cd2",
    storageBucket: "ems-dispatch-d1cd2.firebasestorage.app",
    messagingSenderId: "529717769926",
    appId: "1:529717769926:web:6cf7c152a0ca5fbccac9c7",
    measurementId: "G-TZZFDBHVM2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const statusText = document.getElementById("statusText");
  const addTaskForm = document.getElementById("addTaskForm");
  const addColumnForm = document.getElementById("addColumnForm");
  const taskTitleInput = document.getElementById("taskTitle");
  const taskDescInput = document.getElementById("taskDesc");
  const taskColumnSelect = document.getElementById("taskColumn");
  const taskSubSelect = document.getElementById("taskSubcategory");
  const columnNameInput = document.getElementById("columnName");
  const board = document.getElementById("board");

  let columns = [];        // {id, name, order}
  let subcategories = [];  // {id, columnId, name, order}
  let tasks = [];          // {id, title, description, columnId, subcategoryId}

  let hasInitializedColumns = false;

  function setStatus(msg, ok = true) {
    statusText.textContent = msg;
    statusText.classList.toggle("ok", ok);
    statusText.classList.toggle("err", !ok);
  }

  function formatDate(timestamp) {
    if (!timestamp) return "";
    const date = timestamp.toDate();
    return date.toLocaleString("fr-FR", {
      day: "2-digit",
      month: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function updateTaskSubSelect() {
    const colId = taskColumnSelect.value;
    taskSubSelect.innerHTML = "";

    const optNone = document.createElement("option");
    optNone.value = "";
    optNone.textContent = "Sans sous-cat√©gorie";
    taskSubSelect.appendChild(optNone);

    if (!colId) return;

    const subsForCol = subcategories
      .filter(s => s.columnId === colId)
      .sort((a, b) => (a.order || 0) - (b.order || 0));

    subsForCol.forEach(sub => {
      const opt = document.createElement("option");
      opt.value = sub.id;
      opt.textContent = sub.name;
      taskSubSelect.appendChild(opt);
    });
  }

  function updateTaskColumnSelect() {
    const current = taskColumnSelect.value;
    taskColumnSelect.innerHTML = "";
    columns.forEach(col => {
      const opt = document.createElement("option");
      opt.value = col.id;
      opt.textContent = col.name;
      taskColumnSelect.appendChild(opt);
    });
    if (columns.length) {
      const found = columns.find(c => c.id === current) || columns[0];
      taskColumnSelect.value = found.id;
    }
    updateTaskSubSelect();
  }

  taskColumnSelect.addEventListener("change", updateTaskSubSelect);

  function createCard(id, data, label) {
    const card = document.createElement("div");
    card.className = "card";
    card.draggable = true;
    card.dataset.id = id;

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = data.title || "(Sans titre)";

    const desc = document.createElement("div");
    desc.className = "card-desc";
    desc.textContent = data.description || "";

    const meta = document.createElement("div");
    meta.className = "card-meta";

    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = label || "Sans cat√©gorie";

    const date = document.createElement("span");
    date.textContent = formatDate(data.createdAt);

    meta.appendChild(tag);
    meta.appendChild(date);

    card.appendChild(title);
    if (data.description) card.appendChild(desc);
    card.appendChild(meta);

    card.addEventListener("dragstart", (e) => {
      e.dataTransfer.setData("text/plain", id);
    });

    // double-clic -> supprimer carte
    card.addEventListener("dblclick", async () => {
      if (confirm("Supprimer cette carte ?")) {
        try {
          await db.collection("tasks").doc(id).delete();
        } catch (err) {
          console.error(err);
          alert("Erreur lors de la suppression.");
        }
      }
    });

    return card;
  }

  async function deleteColumnAndTasks(columnId, columnName) {
    const ok = confirm(`Supprimer la cat√©gorie "${columnName}" et toutes ses cartes ?`);
    if (!ok) return;

    try {
      setStatus("Suppression de la cat√©gorie...", true);

      // t√¢ches de cette colonne
      const tasksSnap = await db.collection("tasks").where("columnId", "==", columnId).get();
      const subsSnap  = await db.collection("subcategories").where("columnId", "==", columnId).get();

      const batch = db.batch();
      tasksSnap.forEach(doc => batch.delete(doc.ref));
      subsSnap.forEach(doc => batch.delete(doc.ref));
      batch.delete(db.collection("columns").doc(columnId));
      await batch.commit();

      setStatus("Connect√©", true);
    } catch (err) {
      console.error(err);
      setStatus("Erreur lors de la suppression de la cat√©gorie", false);
      alert("Erreur lors de la suppression de la cat√©gorie.");
    }
  }

  async function deleteSubcategoryAndMoveTasks(subId, subName) {
    const ok = confirm(`Supprimer la sous-cat√©gorie "${subName}" et renvoyer ses cartes dans "Sans sous-cat√©gorie" ?`);
    if (!ok) return;

    try {
      setStatus("Suppression de la sous-cat√©gorie...", true);
      const snap = await db.collection("tasks").where("subcategoryId", "==", subId).get();
      const batch = db.batch();
      snap.forEach(doc => {
        batch.update(doc.ref, { subcategoryId: null });
      });
      batch.delete(db.collection("subcategories").doc(subId));
      await batch.commit();
      setStatus("Connect√©", true);
    } catch (err) {
      console.error(err);
      setStatus("Erreur lors de la suppression de la sous-cat√©gorie", false);
      alert("Erreur lors de la suppression de la sous-cat√©gorie.");
    }
  }

  function renderBoard() {
  board.innerHTML = "";

  columns.forEach(column => {
    const colArticle = document.createElement("article");
    colArticle.className = "column";

    const header = document.createElement("div");
    header.className = "column-header";

    const headerLeft = document.createElement("div");
    headerLeft.style.display = "flex";
    headerLeft.style.alignItems = "center";
    headerLeft.style.gap = "0.35rem";

    const titleSpan = document.createElement("span");
    titleSpan.className = "column-title";
    titleSpan.textContent = column.name;

    const countSpan = document.createElement("span");
    countSpan.className = "column-count";

    headerLeft.appendChild(titleSpan);
    headerLeft.appendChild(countSpan);

    const headerActions = document.createElement("div");
    headerActions.className = "column-actions";

    // bouton ajout sous-cat√©gorie
    const addSubBtn = document.createElement("button");
    addSubBtn.className = "icon-btn";
    addSubBtn.title = "Ajouter une sous-cat√©gorie";
    addSubBtn.textContent = "+";
    addSubBtn.addEventListener("click", async () => {
      const name = prompt("Nom de la nouvelle sous-cat√©gorie :");
      if (!name) return;
      try {
        const currentSubs = subcategories.filter(s => s.columnId === column.id);
        const order = currentSubs.length
          ? Math.max(...currentSubs.map(s => s.order || 0)) + 1
          : 0;
        await db.collection("subcategories").add({
          columnId: column.id,
          name: name.trim(),
          order,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (err) {
        console.error(err);
        alert("Erreur lors de l'ajout de la sous-cat√©gorie.");
      }
    });

    const deleteBtn = document.createElement("button");
    deleteBtn.className = "icon-btn";
    deleteBtn.title = "Supprimer la cat√©gorie";
    deleteBtn.textContent = "üóë";
    deleteBtn.addEventListener("click", () => {
      deleteColumnAndTasks(column.id, column.name);
    });

    headerActions.appendChild(addSubBtn);
    headerActions.appendChild(deleteBtn);

    header.appendChild(headerLeft);
    header.appendChild(headerActions);

    const body = document.createElement("div");
    body.className = "column-body";

    // t√¢ches de cette colonne
    const tasksForColumn = tasks.filter(t => t.columnId === column.id);
    countSpan.textContent = tasksForColumn.length;

    // sous-cat√©gories pour cette colonne
    const subsForCol = subcategories
      .filter(s => s.columnId === column.id)
      .sort((a, b) => (a.order || 0) - (b.order || 0));

    // üëâ bloc "Sans sous-cat√©gorie" TOUJOURS visible
    const noSubTasks = tasksForColumn.filter(t => !t.subcategoryId);
    const noSubBlock = document.createElement("div");
    noSubBlock.className = "subcategory subcategory--none";

    const nsHeader = document.createElement("div");
    nsHeader.className = "subcategory-header";

    const nsTitle = document.createElement("span");
    nsTitle.className = "subcategory-title";
    nsTitle.textContent = "Sans sous-cat√©gorie";

    const nsCount = document.createElement("span");
    nsCount.className = "subcategory-count";
    nsCount.textContent = noSubTasks.length;

    nsHeader.appendChild(nsTitle);
    nsHeader.appendChild(nsCount);

    const noSubBody = document.createElement("div");
    noSubBody.className = "subcategory-body";
    noSubBody.dataset.columnId = column.id;
    noSubBody.dataset.subId = "";

    noSubTasks.forEach(item => {
      const label = column.name;
      const card = createCard(item.id, item, label);
      noSubBody.appendChild(card);
    });

    // drag & drop sur bloc "sans sous-cat√©gorie"
    noSubBody.addEventListener("dragover", (e) => {
      e.preventDefault();
      noSubBody.classList.add("subcategory-body--hover");
    });
    noSubBody.addEventListener("dragleave", () => {
      noSubBody.classList.remove("subcategory-body--hover");
    });
    noSubBody.addEventListener("drop", async (e) => {
      e.preventDefault();
      noSubBody.classList.remove("subcategory-body--hover");
      const id = e.dataTransfer.getData("text/plain");
      if (!id) return;
      try {
        await db.collection("tasks").doc(id).update({
          columnId: column.id,
          subcategoryId: null
        });
      } catch (err) {
        console.error(err);
        alert("Erreur lors du d√©placement de la carte.");
      }
    });

    noSubBlock.appendChild(nsHeader);
    noSubBlock.appendChild(noSubBody);
    body.appendChild(noSubBlock);

    // blocs pour chaque sous-cat√©gorie
    subsForCol.forEach(sub => {
      const subBlock = document.createElement("div");
      subBlock.className = "subcategory";

      const subHeader = document.createElement("div");
      subHeader.className = "subcategory-header";

      const subHeaderLeft = document.createElement("div");
      subHeaderLeft.style.display = "flex";
      subHeaderLeft.style.alignItems = "center";
      subHeaderLeft.style.gap = "0.25rem";

      const subTitle = document.createElement("span");
      subTitle.className = "subcategory-title";
      subTitle.textContent = sub.name;

      // renommage sous-cat√©gorie
      subTitle.addEventListener("dblclick", () => {
        const input = document.createElement("input");
        input.type = "text";
        input.value = sub.name;
        input.style.fontSize = "0.8rem";
        input.style.padding = "0.05rem 0.3rem";
        input.style.borderRadius = "0.4rem";
        input.style.border = "1px solid #9ca3af";
        input.style.outline = "none";
        subHeaderLeft.replaceChild(input, subTitle);
        input.focus();
        input.select();

        const finish = async (save) => {
          const newName = input.value.trim();
          subHeaderLeft.replaceChild(subTitle, input);
          if (save && newName && newName !== sub.name) {
            try {
              await db.collection("subcategories").doc(sub.id).update({ name: newName });
            } catch (err) {
              console.error(err);
              alert("Erreur lors du renommage de la sous-cat√©gorie.");
            }
          }
        };

        input.addEventListener("blur", () => finish(true));
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") finish(true);
          if (e.key === "Escape") finish(false);
        });
      });

      const subCount = document.createElement("span");
      subCount.className = "subcategory-count";

      subHeaderLeft.appendChild(subTitle);
      subHeaderLeft.appendChild(subCount);

      const subActions = document.createElement("div");
      const delSubBtn = document.createElement("button");
      delSubBtn.className = "icon-btn";
      delSubBtn.title = "Supprimer la sous-cat√©gorie";
      delSubBtn.textContent = "üóë";
      delSubBtn.addEventListener("click", () => {
        deleteSubcategoryAndMoveTasks(sub.id, sub.name);
      });
      subActions.appendChild(delSubBtn);

      subHeader.appendChild(subHeaderLeft);
      subHeader.appendChild(subActions);

      const subBody = document.createElement("div");
      subBody.className = "subcategory-body";
      subBody.dataset.columnId = column.id;
      subBody.dataset.subId = sub.id;

      const tasksForSub = tasksForColumn.filter(t => t.subcategoryId === sub.id);
      subCount.textContent = tasksForSub.length;

      tasksForSub.forEach(item => {
        const label = sub.name;
        const card = createCard(item.id, item, label);
        subBody.appendChild(card);
      });

      // drag & drop sur cette sous-cat√©gorie
      subBody.addEventListener("dragover", (e) => {
        e.preventDefault();
        subBody.classList.add("subcategory-body--hover");
      });
      subBody.addEventListener("dragleave", () => {
        subBody.classList.remove("subcategory-body--hover");
      });
      subBody.addEventListener("drop", async (e) => {
        e.preventDefault();
        subBody.classList.remove("subcategory-body--hover");
        const id = e.dataTransfer.getData("text/plain");
        if (!id) return;
        try {
          await db.collection("tasks").doc(id).update({
            columnId: column.id,
            subcategoryId: sub.id
          });
        } catch (err) {
          console.error(err);
          alert("Erreur lors du d√©placement de la carte.");
        }
      });

      subBlock.appendChild(subHeader);
      subBlock.appendChild(subBody);
      body.appendChild(subBlock);
    });

    colArticle.appendChild(header);
    colArticle.appendChild(body);
    board.appendChild(colArticle);
  });

  updateTaskColumnSelect();
}

      // On n'affiche le bloc "Sans sous-cat√©gorie" que s'il y a des cartes
      if (noSubTasks.length > 0) {
        const nsHeader = document.createElement("div");
        nsHeader.className = "subcategory-header";
        const nsTitle = document.createElement("span");
        nsTitle.className = "subcategory-title";
        nsTitle.textContent = "Sans sous-cat√©gorie";
        const nsCount = document.createElement("span");
        nsCount.className = "subcategory-count";
        nsCount.textContent = noSubTasks.length;
        nsHeader.appendChild(nsTitle);
        nsHeader.appendChild(nsCount);
        noSubBlock.appendChild(nsHeader);
        noSubBlock.appendChild(noSubBody);
        body.appendChild(noSubBlock);
      }

      // blocs pour chaque sous-cat√©gorie
      subsForCol.forEach(sub => {
        const subBlock = document.createElement("div");
        subBlock.className = "subcategory";

        const subHeader = document.createElement("div");
        subHeader.className = "subcategory-header";

        const subHeaderLeft = document.createElement("div");
        subHeaderLeft.style.display = "flex";
        subHeaderLeft.style.alignItems = "center";
        subHeaderLeft.style.gap = "0.25rem";

        const subTitle = document.createElement("span");
        subTitle.className = "subcategory-title";
        subTitle.textContent = sub.name;

        // renommage sous-cat√©gorie
        subTitle.addEventListener("dblclick", () => {
          const input = document.createElement("input");
          input.type = "text";
          input.value = sub.name;
          input.style.fontSize = "0.8rem";
          input.style.padding = "0.05rem 0.3rem";
          input.style.borderRadius = "0.4rem";
          input.style.border = "1px solid #9ca3af";
          input.style.outline = "none";
          subHeaderLeft.replaceChild(input, subTitle);
          input.focus();
          input.select();

          const finish = async (save) => {
            const newName = input.value.trim();
            subHeaderLeft.replaceChild(subTitle, input);
            if (save && newName && newName !== sub.name) {
              try {
                await db.collection("subcategories").doc(sub.id).update({ name: newName });
              } catch (err) {
                console.error(err);
                alert("Erreur lors du renommage de la sous-cat√©gorie.");
              }
            }
          };

          input.addEventListener("blur", () => finish(true));
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") finish(true);
            if (e.key === "Escape") finish(false);
          });
        });

        const subCount = document.createElement("span");
        subCount.className = "subcategory-count";

        subHeaderLeft.appendChild(subTitle);
        subHeaderLeft.appendChild(subCount);

        const subActions = document.createElement("div");
        const delSubBtn = document.createElement("button");
        delSubBtn.className = "icon-btn";
        delSubBtn.title = "Supprimer la sous-cat√©gorie";
        delSubBtn.textContent = "üóë";
        delSubBtn.addEventListener("click", () => {
          deleteSubcategoryAndMoveTasks(sub.id, sub.name);
        });
        subActions.appendChild(delSubBtn);

        subHeader.appendChild(subHeaderLeft);
        subHeader.appendChild(subActions);

        const subBody = document.createElement("div");
        subBody.className = "subcategory-body";
        subBody.dataset.columnId = column.id;
        subBody.dataset.subId = sub.id;

        const tasksForSub = tasksForColumn.filter(t => t.subcategoryId === sub.id);
        subCount.textContent = tasksForSub.length;

        tasksForSub.forEach(item => {
          const label = sub.name;
          const card = createCard(item.id, item, label);
          subBody.appendChild(card);
        });

        // drag & drop sur cette sous-cat√©gorie
        subBody.addEventListener("dragover", (e) => {
          e.preventDefault();
          subBody.classList.add("subcategory-body--hover");
        });
        subBody.addEventListener("dragleave", () => {
          subBody.classList.remove("subcategory-body--hover");
        });
        subBody.addEventListener("drop", async (e) => {
          e.preventDefault();
          subBody.classList.remove("subcategory-body--hover");
          const id = e.dataTransfer.getData("text/plain");
          if (!id) return;
          try {
            await db.collection("tasks").doc(id).update({
              columnId: column.id,
              subcategoryId: sub.id
            });
          } catch (err) {
            console.error(err);
            alert("Erreur lors du d√©placement de la carte.");
          }
        });

        subBlock.appendChild(subHeader);
        subBlock.appendChild(subBody);
        body.appendChild(subBlock);
      });

      colArticle.appendChild(header);
      colArticle.appendChild(body);
      board.appendChild(colArticle);
    });

    updateTaskColumnSelect();
  }

  async function createDefaultColumns() {
    const names = ["√Ä faire", "En cours", "Termin√©"];
    const batch = db.batch();
    const colsRef = db.collection("columns");
    names.forEach((name, index) => {
      const ref = colsRef.doc();
      batch.set(ref, {
        name,
        order: index,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await batch.commit();
  }

  // colonnes
  db.collection("columns")
    .orderBy("order", "asc")
    .onSnapshot(async (snapshot) => {
      setStatus("Connect√©");
      if (!hasInitializedColumns && snapshot.empty) {
        hasInitializedColumns = true;
        await createDefaultColumns();
        return;
      }
      hasInitializedColumns = true;
      columns = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      renderBoard();
    }, (error) => {
      console.error(error);
      setStatus("Erreur de connexion aux cat√©gories", false);
    });

  // sous-cat√©gories
  db.collection("subcategories")
    .orderBy("order", "asc")
    .onSnapshot((snapshot) => {
      setStatus("Connect√©");
      subcategories = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      renderBoard();
    }, (error) => {
      console.error(error);
      setStatus("Erreur de connexion aux sous-cat√©gories", false);
    });

  // t√¢ches
  db.collection("tasks")
    .orderBy("createdAt", "asc")
    .onSnapshot((snapshot) => {
      setStatus("Connect√©");
      tasks = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      renderBoard();
    }, (error) => {
      console.error(error);
      setStatus("Erreur de connexion aux t√¢ches", false);
    });

  // ajout carte
  addTaskForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const title = taskTitleInput.value.trim();
    const description = taskDescInput.value.trim();
    const columnId = taskColumnSelect.value;
    const subId = taskSubSelect.value || null;

    if (!title || !columnId) return;

    try {
      await db.collection("tasks").add({
        title,
        description,
        columnId,
        subcategoryId: subId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      taskTitleInput.value = "";
      taskDescInput.value = "";
    } catch (err) {
      console.error(err);
      alert("Erreur lors de l'ajout de la t√¢che.");
    }
  });

  // ajout cat√©gorie
  addColumnForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = columnNameInput.value.trim();
    if (!name) return;

    try {
      const order = columns.length ? Math.max(...columns.map(c => c.order || 0)) + 1 : 0;
      await db.collection("columns").add({
        name,
        order,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      columnNameInput.value = "";
    } catch (err) {
      console.error(err);
      alert("Erreur lors de l'ajout de la cat√©gorie.");
    }
  });
</script>
</body>
</html>
